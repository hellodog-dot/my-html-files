<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRT时间轴检查与修改工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .upload-container {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        #fileInput {
            display: none;
        }
        .upload-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .upload-btn:hover {
            background-color: #45a049;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0b7dda;
        }
        #results {
            margin-top: 20px;
        }
        .file-result {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .file-result.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .download-btn {
            background-color: #ff9800;
        }
        .download-btn:hover {
            background-color: #e68a00;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-top: 10px;
        }
        .summary {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>SRT时间轴检查与修改工具</h1>
    <p>此工具批量删除1小时时间轴（一般用于修改达芬奇的srt）</p>
    
    <div class="upload-container">
        <label for="fileInput" class="upload-btn">选择SRT文件</label>
        <input type="file" id="fileInput" multiple accept=".srt">
        <p>请选择一个或多个SRT字幕文件</p>
    </div>
    
    <div class="action-buttons">
        <button id="checkBtn">检查时间轴</button>
        <button id="modifyBtn" disabled>批量修改时间轴</button>
        <button id="downloadBtn" disabled class="download-btn">下载修改后的文件</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const checkBtn = document.getElementById('checkBtn');
            const modifyBtn = document.getElementById('modifyBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const resultsContainer = document.getElementById('results');
            
            let files = [];
            let filesWithOverOneHour = [];
            let modifiedFiles = [];
            
            // 选择文件
            fileInput.addEventListener('change', function(e) {
                files = Array.from(e.target.files);
                resultsContainer.innerHTML = '';
                
                if (files.length > 0) {
                    // 显示已选择的文件
                    let fileNames = files.map(file => file.name).join(', ');
                    resultsContainer.innerHTML = `<div class="summary">已选择 ${files.length} 个文件: ${fileNames}</div>`;
                }
            });
            
            // 检查时间轴
            checkBtn.addEventListener('click', function() {
                if (files.length === 0) {
                    alert('请先选择SRT文件');
                    return;
                }
                
                resultsContainer.innerHTML = '<div class="summary">正在处理文件，请稍候...</div>';
                filesWithOverOneHour = [];
                
                // 处理每个文件
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        const result = checkSrtTimecodes(content, file.name);
                        
                        if (result.hasOverOneHour) {
                            filesWithOverOneHour.push({
                                file: file,
                                content: content,
                                overOneHourCount: result.overOneHourCount
                            });
                            
                            const fileResult = document.createElement('div');
                            fileResult.className = 'file-result error';
                            fileResult.innerHTML = `
                                <h3>${file.name}</h3>
                                <p>发现 ${result.overOneHourCount} 处时间轴超过1小时</p>
                                <pre>${result.example}</pre>
                            `;
                            resultsContainer.appendChild(fileResult);
                        }
                        
                        // 检查是否所有文件都处理完毕
                        if (filesWithOverOneHour.length + (files.length - filesWithOverOneHour.length) === files.length) {
                            if (filesWithOverOneHour.length > 0) {
                                modifyBtn.disabled = false;
                                downloadBtn.disabled = false;
                                
                                const summary = document.createElement('div');
                                summary.className = 'summary';
                                summary.innerHTML = `<h3>总计发现 ${filesWithOverOneHour.length} 个文件存在超过1小时的时间轴</h3>`;
                                resultsContainer.insertBefore(summary, resultsContainer.firstChild.nextSibling);
                            } else {
                                modifyBtn.disabled = true;
                                downloadBtn.disabled = true;
                                
                                const summary = document.createElement('div');
                                summary.className = 'summary';
                                summary.innerHTML = `<h3>所有文件时间轴正常</h3>`;
                                resultsContainer.innerHTML = summary.outerHTML;
                            }
                        }
                    };
                    reader.readAsText(file);
                });
            });
            
            // 批量修改时间轴
            modifyBtn.addEventListener('click', function() {
                if (filesWithOverOneHour.length === 0) {
                    alert('没有需要修改的文件');
                    return;
                }
                
                resultsContainer.innerHTML = '<div class="summary">正在修改文件，请稍候...</div>';
                modifiedFiles = [];
                
                filesWithOverOneHour.forEach(item => {
                    const modifiedContent = modifySrtTimecodes(item.content);
                    
                    modifiedFiles.push({
                        name: item.file.name,
                        content: modifiedContent
                    });
                    
                    const fileResult = document.createElement('div');
                    fileResult.className = 'file-result';
                    fileResult.innerHTML = `
                        <h3>${item.file.name}</h3>
                        <p>时间轴已成功修改</p>
                        <pre>${getModificationExample(item.content, modifiedContent)}</pre>
                    `;
                    resultsContainer.appendChild(fileResult);
                    
                    // 检查是否所有文件都处理完毕
                    if (modifiedFiles.length === filesWithOverOneHour.length) {
                        downloadBtn.disabled = false;
                        
                        const summary = document.createElement('div');
                        summary.className = 'summary';
                        summary.innerHTML = `<h3>所有 ${modifiedFiles.length} 个文件已成功修改</h3>`;
                        resultsContainer.insertBefore(summary, resultsContainer.firstChild.nextSibling);
                    }
                });
            });
            
            // 下载修改后的文件
            downloadBtn.addEventListener('click', function() {
                if (modifiedFiles.length === 0) {
                    alert('没有可下载的文件');
                    return;
                }
                
                modifiedFiles.forEach(file => {
                    const blob = new Blob([file.content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
                
                alert('所有文件已下载完成');
            });
            
            // 检查SRT时间轴
            function checkSrtTimecodes(content, fileName) {
                const lines = content.split('\n');
                let hasOverOneHour = false;
                let overOneHourCount = 0;
                let example = '';
                let foundExample = false;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const timecodeMatch = line.match(/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/);
                    
                    if (timecodeMatch) {
                        const start = parseTimecode(timecodeMatch[1]);
                        const end = parseTimecode(timecodeMatch[2]);
                        
                        if (start >= 3600000 || end >= 3600000) { // 1小时 = 3600000毫秒
                            hasOverOneHour = true;
                            overOneHourCount++;
                            
                            if (!foundExample) {
                                // 获取上下文
                                const contextLines = [];
                                if (i > 0) contextLines.push(lines[i-1]);
                                contextLines.push(lines[i]);
                                if (i < lines.length - 1) contextLines.push(lines[i+1]);
                                
                                example = contextLines.join('\n');
                                foundExample = true;
                            }
                        }
                    }
                }
                
                return {
                    hasOverOneHour: hasOverOneHour,
                    overOneHourCount: overOneHourCount,
                    example: example
                };
            }
            
            // 修改SRT时间轴
            function modifySrtTimecodes(content) {
                return content.replace(/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/g, function(match, start, end) {
                    const startTime = parseTimecode(start);
                    const endTime = parseTimecode(end);
                    
                    // 如果时间超过1小时，减去1小时
                    if (startTime >= 3600000) {
                        const newStartTime = formatTimecode(startTime - 3600000);
                        start = newStartTime;
                    }
                    
                    if (endTime >= 3600000) {
                        const newEndTime = formatTimecode(endTime - 3600000);
                        end = newEndTime;
                    }
                    
                    return `${start} --> ${end}`;
                });
            }
            
            // 获取修改示例
            function getModificationExample(originalContent, modifiedContent) {
                const originalLines = originalContent.split('\n');
                const modifiedLines = modifiedContent.split('\n');
                let example = '';
                
                for (let i = 0; i < originalLines.length; i++) {
                    if (originalLines[i] !== modifiedLines[i]) {
                        // 获取上下文
                        const contextLines = [];
                        if (i > 0) contextLines.push(originalLines[i-1]);
                        contextLines.push(originalLines[i]);
                        if (i < originalLines.length - 1) contextLines.push(originalLines[i+1]);
                        
                        example += `原内容:\n${contextLines.join('\n')}\n`;
                        
                        const modifiedContextLines = [];
                        if (i > 0) modifiedContextLines.push(modifiedLines[i-1]);
                        modifiedContextLines.push(modifiedLines[i]);
                        if (i < modifiedLines.length - 1) modifiedContextLines.push(modifiedLines[i+1]);
                        
                        example += `修改后:\n${modifiedContextLines.join('\n')}\n`;
                        break;
                    }
                }
                
                return example;
            }
            
            // 解析时间轴为毫秒
            function parseTimecode(timecode) {
                const parts = timecode.split(/[:.,]/);
                const hours = parseInt(parts[0], 10);
                const minutes = parseInt(parts[1], 10);
                const seconds = parseInt(parts[2], 10);
                const milliseconds = parseInt(parts[3], 10);
                
                return (hours * 3600000) + (minutes * 60000) + (seconds * 1000) + milliseconds;
            }
            
            // 格式化毫秒为时间轴
            function formatTimecode(milliseconds) {
                const hours = Math.floor(milliseconds / 3600000);
                milliseconds %= 3600000;
                const minutes = Math.floor(milliseconds / 60000);
                milliseconds %= 60000;
                const seconds = Math.floor(milliseconds / 1000);
                const remainingMilliseconds = milliseconds % 1000;
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')},${remainingMilliseconds.toString().padStart(3, '0')}`;
            }
        });
    </script>
</body>
</html>