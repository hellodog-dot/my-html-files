<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>SRT 批量删除 / 替换（多集版 + 处理集数统计）</title>
<style>
 body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;margin:0;padding:15px;background:#f7f7f7;color:#333}
 h1{margin:0 0 15px 0;font-size:22px}
 .box{background:#fff;border-radius:6px;padding:15px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
 label{font-weight:600;margin-bottom:6px;display:block}
 textarea{width:100%;min-height:120px;resize:vertical;font-family:Consolas,Monaco,monospace;padding:6px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
 .files{margin-top:8px}
 .fileList{max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:6px;margin-top:6px;background:#fafafa;font-size:13px}
 .fileList div{display:flex;justify-content:space-between;align-items:center;padding:2px 0}
 .fileList button{font-size:12px;padding:2px 6px}
</style>
</head>
<body>

<h1>SRT 批量删除 / 替换（多集版 + 处理集数统计）</h1>

<!-- ① 上传多集 SRT -->
<div class="box">
  <label>① 选择多集 SRT（可一次选多文件）</label>
  <input type="file" id="fileInput" accept=".srt" multiple>
  <div class="fileList" id="fileList"></div>
</div>

<!-- ② 删除词 -->
<div class="box">
  <label>② 删除指定词（每行一个）</label>
  <textarea id="deleteList" placeholder="例如：&#10;Hello&#10;world"></textarea>
</div>

<!-- ③ 替换规则（新格式） -->
<div class="box">
  <label>③ 替换规则（格式：待替换词>>>替换结果，每行一条）</label>
  <textarea id="replaceList" placeholder="例如：&#10;Hello>>>Hi&#10;world>>>earth"></textarea>
</div>

<!-- ④ 实时预览（仅第一集） -->
<div class="box">
  <label>④ 预览（仅显示第一集处理后内容）</label>
  <textarea id="preview" readonly></textarea>
</div>

<!-- ⑤ 处理集数统计 -->
<div class="box">
  <label>⑤ 处理集数统计</label>
  <label>1. 删除提示词集数：</label>
  <textarea id="delSetList" readonly placeholder="暂无"></textarea>
  <label style="margin-top:8px">2. 替换指定词集数：</label>
  <textarea id="repSetList" readonly placeholder="暂无"></textarea>
</div>

<!-- ⑥ 批量处理 & 下载 -->
<div class="box">
  <button id="processBtn" class="primary" disabled>打包下载全部结果</button>
</div>

<!-- JSZip CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
/* ---------- 工具函数 ---------- */
const $ = id => document.getElementById(id);
const escapeRegExp = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');

/* ---------- 文件选择与列表 ---------- */
const fileInput = $('fileInput');
const fileListEl = $('fileList');
let originalMap = new Map(); // 文件名 -> 原始内容

fileInput.onchange = async () => {
  originalMap.clear();
  const files = Array.from(fileInput.files);
  fileListEl.innerHTML = '';
  for(const f of files){
    const text = await f.text();
    originalMap.set(f.name, text);
    const row = document.createElement('div');
    row.innerHTML = `<span>${f.name}</span>`;
    fileListEl.appendChild(row);
  }
  $('processBtn').disabled = originalMap.size === 0;
  updatePreviewAndStats();
};

/* ---------- 实时预览 + 统计 ---------- */
const preview = $('preview');
const delSetList = $('delSetList');
const repSetList = $('repSetList');

function updatePreviewAndStats(){
  if(originalMap.size === 0){
    preview.value = '';
    delSetList.value = '';
    repSetList.value = '';
    return;
  }
  // 先统计
  const dels = $('deleteList').value.split(/\r?\n/).filter(Boolean);
  const rules = $('replaceList').value.split(/\r?\n/).filter(l=>l.includes('>>>')).map(l=>{
    const [from,...rest]=l.split('>>>');
    return {from,to:rest.join('>>>')};
  });

  const delSets = [];
  const repSets = [];

  originalMap.forEach((orig, name)=>{
    let tmp = orig;
    dels.forEach(d=>{
      if(!d.trim()) return;
      tmp = tmp.replace(new RegExp(escapeRegExp(d),'g'),'');
    });
    if(tmp !== orig) delSets.push(name);

    tmp = orig;
    rules.forEach(r=>{
      tmp = tmp.replace(new RegExp(escapeRegExp(r.from),'g'),r.to);
    });
    if(tmp !== orig) repSets.push(name);
  });

  // 排序
  delSets.sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));
  repSets.sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));

  delSetList.value = delSets.join('\n');
  repSetList.value = repSets.join('\n');

  // 预览第一集
  const [, firstContent] = originalMap.entries().next().value;
  preview.value = processText(firstContent);
}

['deleteList','replaceList'].forEach(id=>$(id).addEventListener('input',updatePreviewAndStats));

/* ---------- 文本处理 ---------- */
function processText(text){
  // 删除
  const dels = $('deleteList').value.split(/\r?\n/).filter(Boolean);
  dels.forEach(d=>{
    if(!d.trim()) return;
    text = text.replace(new RegExp(escapeRegExp(d),'g'),'');
  });
  // 替换
  const rules = $('replaceList').value.split(/\r?\n/).filter(l=>l.includes('>>>')).map(l=>{
    const [from,...rest]=l.split('>>>');
    return {from,to:rest.join('>>>')};
  });
  rules.forEach(r=>{
    text = text.replace(new RegExp(escapeRegExp(r.from),'g'),r.to);
  });
  return text;
}

/* ---------- 批量打包下载 ---------- */
$('processBtn').onclick = async () => {
  const zip = new JSZip();
  originalMap.forEach((content, filename)=>{
    zip.file(filename, processText(content));
  });
  const blob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'processed_srt.zip';
  a.click();
};
</script>
</body>
</html>