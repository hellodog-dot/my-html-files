<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRT文件合并工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#69b1ff',
                        neutral: '#f5f7fa',
                        dark: '#1d2129',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-dark min-h-screen flex flex-col">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-file-text text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">SRT文件合并工具</h1>
            </div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#" class="text-gray-600 hover:text-primary transition-all-300">
                    <i class="fa-solid fa-question-circle mr-1"></i>帮助
                </a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all-300">
                    <i class="fa-solid fa-github mr-1"></i>源码
                </a>
            </div>
            <button class="md:hidden text-gray-600 hover:text-primary transition-all-300">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-soft p-6 md:p-8 mb-8">
            <!-- 上传区域 -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-upload text-primary mr-2"></i>文件上传
                </h2>
                <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-all-300 cursor-pointer bg-neutral">
                    <input type="file" id="file-input" multiple accept=".srt" class="hidden">
                    <i class="fa-solid fa-file-import text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-2">拖拽SRT文件到此处，或</p>
                    <button id="select-files-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-all-300 shadow-md hover:shadow-lg">
                        <i class="fa-solid fa-plus mr-1"></i>选择文件
                    </button>
                    <p class="text-gray-500 text-sm mt-4">支持多选，将按文件名排序后合并</p>
                </div>
            </div>

            <!-- 文件列表 -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-list text-primary mr-2"></i>文件列表
                </h2>
                <div id="file-list" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                    <div class="text-gray-500 text-center py-6">
                        未选择任何文件
                    </div>
                </div>
            </div>

            <!-- 选项设置 -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-sliders text-primary mr-2"></i>输出设置
                </h2>
                <div class="space-y-4">
                    <div class="flex flex-col md:flex-row md:items-center gap-4">
                        <label class="font-medium text-gray-700 w-full md:w-1/3">输出格式</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="output-format" value="full" class="form-radio h-5 w-5 text-primary" checked>
                                <span class="ml-2">带时间轴</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="output-format" value="text" class="form-radio h-5 w-5 text-primary">
                                <span class="ml-2">纯文本</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="flex flex-wrap gap-4 justify-center">
                <button id="merge-btn" class="bg-primary hover:bg-primary/90 text-white px-8 py-3 rounded-lg transition-all-300 shadow-md hover:shadow-lg flex items-center">
                    <i class="fa-solid fa-file-export mr-2"></i>开始合并
                </button>
                <button id="clear-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-8 py-3 rounded-lg transition-all-300 shadow-md hover:shadow-lg flex items-center">
                    <i class="fa-solid fa-trash mr-2"></i>清空文件
                </button>
            </div>
        </div>

        <!-- 预览区域 -->
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-soft p-6 md:p-8 mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fa-solid fa-eye text-primary mr-2"></i>预览
            </h2>
            <div id="preview-container" class="min-h-[200px] border border-gray-200 rounded-lg p-4 bg-neutral overflow-auto max-h-[400px]">
                <div class="text-gray-500 text-center py-12">
                    合并后的内容将在这里预览
                </div>
            </div>
            <div class="mt-4 text-right">
                <button id="download-btn" class="bg-secondary hover:bg-secondary/90 text-white px-6 py-2 rounded-lg transition-all-300 shadow-md hover:shadow-lg hidden">
                    <i class="fa-solid fa-download mr-1"></i>下载TXT
                </button>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fa-solid fa-file-text text-primary text-xl"></i>
                        <span class="font-bold text-lg">SRT文件合并工具</span>
                    </div>
                    <p class="text-gray-400 text-sm">高效合并多个SRT字幕文件</p>
                </div>
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-400 hover:text-white transition-all-300">
                        <i class="fa-solid fa-question-circle"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-all-300">
                        <i class="fa-solid fa-github"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-all-300">
                        <i class="fa-solid fa-envelope"></i>
                    </a>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-6 pt-6 text-center text-gray-500 text-sm">
                &copy; 2025 SRT文件合并工具 | 保护隐私，所有操作在本地完成
            </div>
        </div>
    </footer>

    <script>
        // 文件列表
        let selectedFiles = [];
        // 正则表达式匹配SRT文件中的集数信息
        const episodeRegex = /第?\s*(\d+)\s*集|ep?\s*(\d+)|(\d+)\s*-\s*|(\d+)\.srt/gi;

        // DOM元素
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const selectFilesBtn = document.getElementById('select-files-btn');
        const fileList = document.getElementById('file-list');
        const mergeBtn = document.getElementById('merge-btn');
        const clearBtn = document.getElementById('clear-btn');
        const previewContainer = document.getElementById('preview-container');
        const downloadBtn = document.getElementById('download-btn');

        // 事件监听：拖放区域
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('border-primary', 'bg-primary/5');
        }

        function unhighlight() {
            dropArea.classList.remove('border-primary', 'bg-primary/5');
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // 事件监听：文件选择按钮
        selectFilesBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        // 处理选中的文件
        function handleFiles(files) {
            const newFiles = Array.from(files).filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return ext === 'srt';
            });

            if (newFiles.length === 0) {
                showToast('请选择有效的SRT文件', 'error');
                return;
            }

            // 去重（按文件名）
            const uniqueFiles = newFiles.filter(newFile => {
                return !selectedFiles.some(existingFile => existingFile.name === newFile.name);
            });

            if (uniqueFiles.length === 0) {
                showToast('所选文件已在列表中', 'info');
                return;
            }

            selectedFiles = [...selectedFiles, ...uniqueFiles];
            updateFileList();
            showToast(`已添加 ${uniqueFiles.length} 个文件`, 'success');
        }

        // 更新文件列表显示
        function updateFileList() {
            if (selectedFiles.length === 0) {
                fileList.innerHTML = `
                    <div class="text-gray-500 text-center py-6">
                        未选择任何文件
                    </div>
                `;
                return;
            }

            // 按文件名排序
            selectedFiles.sort((a, b) => {
                return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
            });

            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const episodeNum = extractEpisodeNumber(file.name);
                const fileItem = document.createElement('div');
                fileItem.className = 'bg-white border border-gray-200 rounded-lg p-3 flex items-center justify-between hover:shadow-md transition-all-300';
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa-solid fa-file-text text-primary mr-3"></i>
                        <div>
                            <div class="font-medium truncate max-w-[250px]">${file.name}</div>
                            <div class="text-sm text-gray-500">
                                ${formatFileSize(file.size)} 
                                ${episodeNum ? `| 第${episodeNum}集` : ''}
                            </div>
                        </div>
                    </div>
                    <button class="remove-file-btn text-gray-400 hover:text-red-500 transition-all-300" data-index="${index}">
                        <i class="fa-solid fa-times-circle"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });

            // 添加删除文件事件监听
            document.querySelectorAll('.remove-file-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    selectedFiles.splice(index, 1);
                    updateFileList();
                    showToast('文件已移除', 'info');
                });
            });
        }

        // 提取文件名中的集数
        function extractEpisodeNumber(filename) {
            let match;
            let episodeNum = null;
            
            // 重置正则表达式的lastIndex，确保可以多次匹配
            episodeRegex.lastIndex = 0;
            
            while ((match = episodeRegex.exec(filename)) !== null) {
                // 检查所有可能的捕获组
                for (let i = 1; i < match.length; i++) {
                    if (match[i] !== undefined) {
                        episodeNum = parseInt(match[i]);
                        break;
                    }
                }
                if (episodeNum) break;
            }
            
            return episodeNum;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 事件监听：清空文件按钮
        clearBtn.addEventListener('click', () => {
            if (selectedFiles.length === 0) {
                showToast('文件列表已为空', 'info');
                return;
            }
            selectedFiles = [];
            updateFileList();
            previewContainer.innerHTML = `
                <div class="text-gray-500 text-center py-12">
                    合并后的内容将在这里预览
                </div>
            `;
            downloadBtn.classList.add('hidden');
            showToast('文件列表已清空', 'info');
        });

        // 事件监听：合并按钮
        mergeBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                showToast('请先选择SRT文件', 'error');
                return;
            }

            showToast('正在合并文件...', 'info');
            
            try {
                const mergedContent = await mergeSrtFiles(selectedFiles);
                previewContainer.innerHTML = `<pre class="font-mono text-sm">${mergedContent}</pre>`;
                downloadBtn.classList.remove('hidden');
                
                // 存储合并后的内容供下载使用
                downloadBtn.dataset.content = mergedContent;
                
                showToast('合并完成', 'success');
            } catch (error) {
                previewContainer.innerHTML = `
                    <div class="text-red-500 text-center py-12">
                        合并过程中出错: ${error.message}
                    </div>
                `;
                showToast('合并失败', 'error');
                console.error('合并出错:', error);
            }
        });

        // 事件监听：下载按钮
        downloadBtn.addEventListener('click', () => {
            const content = downloadBtn.dataset.content;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const filename = selectedFiles.length > 1 
                ? `合并字幕_${selectedFiles[0].name}_至_${selectedFiles[selectedFiles.length-1].name}.txt` 
                : `${selectedFiles[0].name}.txt`;
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            // 释放URL对象
            URL.revokeObjectURL(link.href);
        });

        // 合并SRT文件
        async function mergeSrtFiles(files) {
            let mergedContent = '';
            const outputFormat = document.querySelector('input[name="output-format"]:checked').value;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const episodeNum = extractEpisodeNumber(file.name) || (i + 1);
                
                // 添加集数标记
                mergedContent += `第${episodeNum}集\n\n`;
                
                // 读取文件内容
                const content = await readFileAsync(file);
                
                // 处理SRT内容
                if (outputFormat === 'full') {
                    // 带时间轴的完整格式
                    mergedContent += content + '\n\n';
                } else {
                    // 纯文本格式
                    const textOnly = extractTextFromSrt(content);
                    mergedContent += textOnly + '\n\n';
                }
            }
            
            return mergedContent.trim();
        }

        // 异步读取文件内容
        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsText(file);
            });
        }

        // 从SRT内容中提取纯文本
        function extractTextFromSrt(srtContent) {
            // 按空行分割SRT内容，每个区块代表一条字幕
            const blocks = srtContent.split(/\r?\n\r?\n/).filter(block => block.trim() !== '');
            
            let textContent = '';
            
            blocks.forEach(block => {
                // 每行内容
                const lines = block.split(/\r?\n/);
                
                // 第一行是序号，第二行是时间轴，从第三行开始是字幕文本
                if (lines.length >= 3) {
                    const textLines = lines.slice(2);
                    textContent += textLines.join(' ') + '\n';
                }
            });
            
            return textContent.trim();
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            // 创建toast元素
            const toast = document.createElement('div');
            
            // 设置样式和类
            let bgColor, textColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-triangle';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-primary';
                    textColor = 'text-white';
                    icon = 'fa-info-circle';
                    break;
            }
            
            toast.className = `${bgColor} ${textColor} px-4 py-3 rounded-lg shadow-lg flex items-center fixed bottom-4 right-4 z-50 transform transition-all duration-300 ease-in-out translate-y-10 opacity-0`;
            toast.innerHTML = `
                <i class="fa-solid ${icon} mr-2"></i>
                <span>${message}</span>
            `;
            
            // 添加到页面
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            }, 10);
            
            // 自动关闭
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // 添加平滑滚动效果
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    </script>
</body>
</html>
    